{% extends 'dashboard.html' %}
{% load static %}
{% block title %}Product | Add-Product{% endblock %}
{% block content %}
                        <div class="main-content-inner">
                            <div class="main-content-wrap">
                                <div class="flex items-center flex-wrap justify-between gap20 mb-27">
                                    <h3>Add Product</h3>
                                    <ul class="breadcrumbs flex items-center flex-wrap justify-start gap10">
                                        <li>
                                            <a href="index-2.html">
                                                <div class="text-tiny">Dashboard</div>
                                            </a>
                                        </li>
                                        <li>
                                            <i class="icon-chevron-right"></i>
                                        </li>
                                        <li>
                                            <a href="all-product.html">
                                                <div class="text-tiny">Products</div>
                                            </a>
                                        </li>
                                        <li>
                                            <i class="icon-chevron-right"></i>
                                        </li>
                                        <li>
                                            <div class="text-tiny">Add product</div>
                                        </li>
                                    </ul>
                                </div>
                                <!-- form-add-product -->
                                <form class="tf-section-2 form-add-product" method="POST" enctype="multipart/form-data"
                                    action="">
                                     {% csrf_token %}
                                     
                                    <input type="hidden" name="_token" value="8LNRTO4LPXHvbK2vgRcXqMeLgqtqNGjzWSNru7Xx"
                                        autocomplete="off">
                                    <div class="wg-box">
                                       <fieldset class="name">
                                            <div class="body-title mb-10">Product name <span class="tf-color-1">*</span></div>
                                            <input class="mb-10" type="text" id="productName" name="name" 
                                                placeholder="Enter product name"
                                                value="{{ product.name|default_if_none:'' }}" required>
                                            <div class="text-tiny">Do not exceed 100 characters when entering the product name.</div>
                                        </fieldset>

                                        <fieldset class="name">
                                            <div class="body-title mb-10">Slug <span class="tf-color-1">*</span></div>
                                            <input class="mb-10" type="text" id="productSlug" name="slug" 
                                                placeholder="Enter product slug"
                                                value="{{ product.slug|default_if_none:'' }}" required>
                                            <div class="text-tiny">Do not exceed 100 characters when entering the product slug.</div>
                                        </fieldset>

                                        <div class="gap22 cols">
                                            <fieldset class="category">
                                                <div class="body-title mb-10">Category <span class="tf-color-1">*</span>
                                                </div>
                                                 <div class="select">
                                                    <!-- Category -->
                                                        <select name="category" required>
                                                            <option value="">Choose category</option>
                                                            {% for category in categories %}
                                                                <option value="{{ category.id }}"
                                                                    {% if product and product.category and product.category.id == category.id %}selected{% endif %}>
                                                                    {{ category.name }}
                                                                </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                            </fieldset>
                                            <fieldset class="brand">
                                                <div class="body-title mb-10">Brand <span class="tf-color-1">*</span>
                                                </div>
                                                 <div class="select">
                                                        <!-- Brand -->
                                                    <select name="brand" required>
                                                        <option value="">Choose Brand</option>
                                                        {% for brand in brands %}
                                                            <option value="{{ brand.id }}"
                                                                {% if product and product.brand and product.brand.id == brand.id %}selected{% endif %}>
                                                                {{ brand.name }}
                                                            </option>
                                                        {% endfor %}
                                                    </select>
                                                    </div>
                                            </fieldset>
                                        </div>

                                        <fieldset class="shortdescription">
                                            <div class="body-title mb-10">Short Description <span
                                                    class="tf-color-1">*</span></div>
                                            <textarea class="mb-10 ht-150" name="short_description"
                                                placeholder="Short Description" tabindex="0" aria-required="true"
                                                required="">{{ product.short_description|default_if_none:'' }}</textarea>
                                            <div class="text-tiny">Do not exceed 100 characters when entering the
                                                product name.</div>
                                        </fieldset>

                                        <fieldset class="description">
                                            <div class="body-title mb-10">Details Description <span class="tf-color-1"></span>
                                            </div>
                                             <textarea id="product-description" name="description">{{ product.description|default_if_none:'' }}</textarea>
                                            <!-- <textarea class="mb-10" name="description" placeholder="Description"
                                                tabindex="0" aria-required="true" required=""></textarea> -->
                                            <div class="text-tiny">Do not exceed 100 characters when entering the
                                                product name.</div>
                                        </fieldset>
                                    </div>
                                    <div class="wg-box">
                                    <fieldset>
                                        <div class="body-title">Upload images <span class="tf-color-1">*</span></div>
                                        <div class="upload-image flex-grow d-flex flex-wrap gap-2" id="singleImagePreview">
                                                {% if product and product.image %}
                                                <div class="item" id="imgpreview" style="position: relative;">
                                                    <img id="previewImg" src="{{ product.image.url }}" class="effect8" alt="{{ product.name }}" style="max-height: 120px; border-radius: 8px;">
                                                    <button type="button" class="remove-btn" onclick="removeSingleImage()">×</button>
                                                </div>
                                                {% else %}
                                                <div id="imgpreview" class="item" style="display:none; position: relative;">
                                                    <img id="previewImg" src="" class="effect8" alt="" style="max-height: 120px; border-radius: 8px;">
                                                    <button type="button" class="remove-btn" onclick="removeSingleImage()">×</button>
                                                </div>
                                                {% endif %}
                                                <div id="upload-file" class="item up-load">
                                                    <label class="uploadfile" for="myFile">
                                                        <span class="icon"><i class="icon-upload-cloud"></i></span>
                                                        <span class="body-text">Drop your images here or select <span class="tf-color">click to browse</span></span>
                                                        <input type="file" id="myFile" name="image" accept="image/*">
                                                    </label>
                                                </div>
                                            </div>
                                    </fieldset>

                                  <fieldset>
                                        <div class="body-title mb-10">Upload Gallery Images</div>
                                        <div class="upload-image mb-16 d-flex flex-wrap gap-2" id="galleryPreview">

                                            {% if product %}
                                                {% for img in product.gallery_images.all %}
                                                    <div class="item" style="position: relative;">
                                                        <img src="{{ img.image.url }}" alt="" style="max-height:120px;border-radius:8px;">
                                                    </div>
                                                {% endfor %}
                                            {% endif %}

                                            <div id="galUpload" class="item up-load">
                                                <label class="uploadfile" for="gFile">
                                                    <span class="icon"><i class="icon-upload-cloud"></i></span>
                                                    <span class="text-tiny">
                                                        Drop your images here or select 
                                                        <span class="tf-color">click to browse</span>
                                                    </span>
                                                    <input type="file" id="gFile" name="gallery_images" accept="image/*" multiple>
                                                </label>
                                            </div>
                                        </div>
                                    </fieldset>

                                    

                                        <div class="cols gap22">
                                            <fieldset class="name">
                                                <div class="body-title mb-10">Regular Price <span
                                                        class="tf-color-1">*</span></div>
                                                <input class="mb-10" type="text" placeholder="Enter regular price"
                                                    name="regular_price" tabindex="0" value="{{ product.regular_price|default_if_none:'' }}" aria-required="true"
                                                    >
                                            </fieldset>
                                            <fieldset class="name">
                                                <div class="body-title mb-10">Sale Price <span
                                                        class="tf-color-1">*</span></div>
                                                <input class="mb-10" type="text" placeholder="Enter sale price"
                                                    name="sale_price" tabindex="0" value="{{ product.sale_price|default_if_none:'' }}" aria-required="true">
                                            </fieldset>
                                        </div>


                                        <div class="cols gap22">
                                            <fieldset class="name">
                                                <div class="body-title mb-10">SKU <span class="tf-color-1">*</span>
                                                </div>
                                                <input class="mb-10" type="text" placeholder="Enter SKU" name="SKU"
                                                    tabindex="0" value="{{ product.SKU|default_if_none:'' }}" aria-required="true">
                                            </fieldset>
                                            <fieldset class="name">
                                                <div class="body-title mb-10">Quantity <span class="tf-color-1">*</span>
                                                </div>
                                                <input class="mb-10" type="text" placeholder="Enter quantity"
                                                    name="quantity" tabindex="0" value="{{ product.quantity|default_if_none:'' }}" aria-required="true"
                                                    >
                                            </fieldset>
                                        </div>

                                        <div class="cols gap22">
                                            <fieldset class="name">
                                                <div class="body-title mb-10">Stock</div>
                                                <div class="select mb-10">
                                                    <select name="stock_status">
                                                        <option value="instock" {% if product.stock_status == "instock" %}selected{% endif %}>In Stock</option>
                                                        <option value="outofstock" {% if product.stock_status == "outofstock" %}selected{% endif %}>Out of Stock</option>
                                                    </select>
                                                </div>
                                            </fieldset>
                                            <fieldset class="name">
                                            <div class="body-title mb-10">Points <span
                                                    class="tf-color-1"></span></div>
                                            <input class="mb-10" type="number" 
                                                name="points" tabindex="0" value="{{ product.points|default_if_none:'' }}" aria-required="true">
                                        </fieldset>
                                            

                                        </div>
                                        <!-- Variant Toggle Section -->
                                    <div class="wg-box">
                                    <fieldset class="variant-toggle">
                                        <div class="body-title mb-10">Product Type <span class="tf-color-1">*</span></div>
                                        <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="productTypeToggleSwitch"  name="product_type_toggle"
                                                        {% if product.product_type == "variable" %}checked{% endif %}>
                                                <label class="form-check-label" for="productTypeToggleSwitch">Enable Variants</label>
                                            </div>

                                        <!-- Hidden input to store actual value -->
                                        <input type="hidden" name="product_type" id="productTypeInput" value="{{ product.product_type|default:'simple' }}">
                                    </fieldset>
                                    </div>

                                    <!-- Variant Section -->
                                    <div class="wg-box" id="variantSection" style="display:none">
                                    <fieldset class="variant-options">
                                        <div class="body-title mb-10">Variant Options</div>
                                        <div id="optionContainer">
                                            {% if product and product.product_type == "variable" %}
                                                {% for option in product.options.all %}
                                                    <div class="option-row mb-2">
                                                        <input type="text" 
                                                            name="options[{{ forloop.counter0 }}][name]" 
                                                            value="{{ option.name }}" 
                                                            class="form-control mb-2 option-name" 
                                                            placeholder="Option Name (e.g. Size, Color)">
                                                        <input type="text" 
                                                            name="options[{{ forloop.counter0 }}][value]" 
                                                            value="{{ option.value }}" 
                                                            class="form-control mb-2 option-values" 
                                                            placeholder="Comma separated values (e.g. Small, Red)" 
                                                            onblur="generateVariants()">
                                                        <button type="button" class="btn btn-danger" onclick="this.parentNode.remove(); generateVariants()">Remove</button>
                                                    </div>
                                                {% endfor %}
                                            {% endif %}
                                        </div>

                                        <button type="button" class="tf-button mt-2" onclick="addOption()">+ Add Option</button>
                                    </fieldset>

                                    <fieldset class="variant-combinations mt-4">
                                        <div class="body-title mb-10">Variants</div>
                                         <div id="variantList" class="row g-3">
                                        {% if product and product.product_type == "variable" %}
                                            {% for v in product.variants.all %}
                                                <div class="col-md-12">
                                                    <div class="card shadow-sm border-0 rounded-4 mb-4">
                                                        <div class="card-body">
                                                            <h6 class="fw-bold mb-3 text-danger">
                                                                {% for key, val in v.attributes.options.items %}
                                                                    {{ key }}: {{ val }}{% if not forloop.last %} / {% endif %}
                                                                {% endfor %}
                                                            </h6>

                                                            <input type="hidden" name="variants[{{ forloop.counter0 }}][options]" 
                                                                value="{{ v.attributes.options|safe }}">

                                                            <div class="row g-3">
                                                                <div class="col-md-6">
                                                                    <fieldset>
                                                                        <label>SKU</label>
                                                                        <input type="text" class="form-control" 
                                                                            name="variants[{{ forloop.counter0 }}][sku]" 
                                                                            value="{{ v.sku }}">
                                                                    </fieldset>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <fieldset>
                                                                        <label>Quantity</label>
                                                                        <input type="number" class="form-control" 
                                                                            name="variants[{{ forloop.counter0 }}][stock]" 
                                                                            value="{{ v.stock }}">
                                                                    </fieldset>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <fieldset>
                                                                        <label>Regular Price</label>
                                                                        <input type="text" class="form-control" 
                                                                            name="variants[{{ forloop.counter0 }}][regular_price]" 
                                                                            value="{{ v.price }}">
                                                                    </fieldset>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <fieldset>
                                                                        <label>Sale Price</label>
                                                                        <input type="text" class="form-control" 
                                                                            name="variants[{{ forloop.counter0 }}][sale_price]" 
                                                                            value="{{ v.attributes.sale_price }}">
                                                                    </fieldset>
                                                                </div>
                                                                <div class="col-md-12">
                                                                    <fieldset>
                                                                        <label>Points</label>
                                                                        <input type="text" class="form-control" 
                                                                            name="variants[{{ forloop.counter0 }}][points]" 
                                                                            value="{{ v.attributes.points }}">
                                                                    </fieldset>
                                                                </div>
                                                                <div class="col-md-12">
                                                                    <fieldset>
                                                                        <label>Description</label>
                                                                        <textarea class="form-control" 
                                                                                name="variants[{{ forloop.counter0 }}][description]">{{ v.attributes.description }}</textarea>
                                                                    </fieldset>
                                                                </div>
                                                                <div class="col-md-12">
                                                                <label>Image</label>
                                                                <input type="file" name="variants[{{ forloop.counter0 }}][image]" class="form-control">

                                                                {% if v.image %}
                                                                    <img src="{{ v.image.url }}" class="img-thumbnail mt-2" style="max-height:100px;">
                                                                    <!-- Hidden field me purana image ka path bhejo -->
                                                                    <input type="hidden" name="variants[{{ forloop.counter0 }}][existing_image]" value="{{ v.image.name }}">
                                                                {% endif %}
                                                            </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    </fieldset>
                                    </div>

                                        <div class="cols gap10">
                                            <button class="tf-button w-full" type="submit">
                                             {% if product %}Update Product{% else %}Add Product{% endif %}
                                            </button>
                                        </div>
                                    </div>
                                </form>

                                <!-- /form-add-product -->
                            </div>
                            </div>
 <script>
// function to slugify text
function slugify(text) {
    return text
        .toString()
        .toLowerCase()
        .trim()
        .replace(/&/g, '-and-')         
        .replace(/[\s\W-]+/g, '-')      
        .replace(/^-+|-+$/g, '');     
}

// auto update slug when typing in product name
document.getElementById("productName").addEventListener("input", function() {
    let name = this.value;
    let slug = slugify(name);
    document.getElementById("productSlug").value = slug;
});
</script>

{% endblock %}

